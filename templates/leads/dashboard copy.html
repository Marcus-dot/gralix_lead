<!-- Updated templates/leads/dashboard.html -->
{% extends 'leads/base.html' %}
{% load static %}

{% block content %}
    <!-- Header -->
    <div class="header-gradient text-white py-4">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-building fs-1 me-3"></i>
                        <div>
                            <h1 class="mb-0 fs-2 fw-bold">Gralix Holdings</h1>
                            <p class="mb-0 text-light">Lead Management System</p>
                        </div>
                    </div>
                    <div class="d-flex gap-3">
                        <span class="badge bg-primary px-3 py-2">Gralix Tech</span>
                        <span class="badge bg-success px-3 py-2">Gralix Actuarial</span>
                        <span class="badge bg-warning px-3 py-2">Gralix Capital</span>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <div class="btn-group me-2">
                        <button class="btn btn-outline-light" id="bulkAssignBtn" type="button">
                            <i class="bi bi-people me-2"></i>Bulk Assign
                        </button>
                        <button class="btn btn-light" id="addLeadBtn" type="button">
                            <i class="bi bi-plus-circle me-2"></i>Add New Lead
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid py-4">
        <!-- Loading indicator -->
        <div id="loadingIndicator" class="text-center py-4" style="display: none;">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <!-- Quick View Cards -->
        <div class="row mb-4" id="quickViewCards"></div>

        <!-- Revenue Analytics -->
        <div class="row mb-4">
            <div class="col-lg-4 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Revenue Pipeline</h5>
                    </div>
                    <div class="card-body" id="revenueOverview"></div>
                </div>
            </div>
            <div class="col-lg-4 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Division Performance</h5>
                    </div>
                    <div class="card-body" id="divisionPerformance"></div>
                </div>
            </div>
            <div class="col-lg-4 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-people me-2"></i>Team Performance</h5>
                    </div>
                    <div class="card-body" id="teamPerformance"></div>
                </div>
            </div>
        </div>

        <!-- Deal Stage Pipeline -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="bi bi-bullseye me-2"></i>Deal Stage Pipeline</h5>
            </div>
            <div class="card-body">
                <div class="row text-center" id="dealStagePipeline"></div>
            </div>
        </div>

        <!-- Search and Filters -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-funnel me-2"></i>Search & Filter Leads</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-lg-3">
                        <label class="form-label">Search</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="searchInput" placeholder="Search company or contact...">
                        </div>
                    </div>
                    <div class="col-lg-2">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="statusFilter">
                            <option value="all">All Status</option>
                            <option value="new">New</option>
                            <option value="contacted">Contacted</option>
                            <option value="qualified">Qualified</option>
                            <option value="proposal">Proposal</option>
                            <option value="negotiation">Negotiation</option>
                            <option value="hot">Hot</option>
                            <option value="won">Won</option>
                            <option value="lost">Lost</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="col-lg-2">
                        <label class="form-label">Division</label>
                        <select class="form-select" id="divisionFilter">
                            <option value="all">All Divisions</option>
                            <option value="tech">Gralix Tech</option>
                            <option value="actuarial">Gralix Actuarial</option>
                            <option value="capital">Gralix Capital</option>
                        </select>
                    </div>
                    <div class="col-lg-2">
                        <label class="form-label">Assigned To</label>
                        <select class="form-select" id="personnelFilter">
                            <option value="all">All Personnel</option>
                            <option value="unassigned">Unassigned</option>
                        </select>
                    </div>
                    <div class="col-lg-1">
                        <label class="form-label">Priority</label>
                        <select class="form-select" id="priorityFilter">
                            <option value="all">All</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div class="col-lg-2">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary w-100 d-block" id="applyFiltersBtn">
                            <i class="bi bi-funnel me-1"></i>Apply Filters
                        </button>
                    </div>
                </div>
                
                <!-- Results Summary -->
                <div class="mt-3">
                    <div class="alert alert-info mb-0 d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-info-circle me-2"></i>
                            Showing <strong id="resultsCount">0</strong> leads
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-info me-2" id="clearFiltersBtn">Clear All Filters</button>
                            <div class="btn-group btn-group-sm">
                                <input type="checkbox" class="btn-check" id="selectAll">
                                <label class="btn btn-outline-secondary" for="selectAll">Select All</label>
                                <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                    Bulk Actions
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" id="bulkReassignBtn"><i class="bi bi-person-gear me-2"></i>Reassign Selected</a></li>
                                    <li><a class="dropdown-item" href="#" id="bulkUpdateStatusBtn"><i class="bi bi-flag me-2"></i>Update Status</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" id="bulkDeleteBtn"><i class="bi bi-trash me-2"></i>Delete Selected</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leads Table -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-table me-2"></i>Company Leads</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th width="40"><input type="checkbox" id="selectAllHeader"></th>
                                <th><i class="bi bi-building me-1"></i>Company</th>
                                <th><i class="bi bi-person me-1"></i>Contact</th>
                                <th><i class="bi bi-person-badge me-1"></i>Assigned To</th>
                                <th><i class="bi bi-diagram-3 me-1"></i>Division</th>
                                <th><i class="bi bi-flag me-1"></i>Status & Progress</th>
                                <th><i class="bi bi-exclamation-triangle me-1"></i>Priority</th>
                                <th><i class="bi bi-currency-dollar me-1"></i>Deal Value</th>
                                <th><i class="bi bi-calendar me-1"></i>Next Follow-up</th>
                                <th><i class="bi bi-gear me-1"></i>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="leadsTableBody">
                            <tr>
                                <td colspan="10" class="text-center py-4">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Loading leads...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- No Results Message -->
                <div id="noResultsMessage" class="text-center py-5" style="display: none;">
                    <i class="bi bi-search fs-1 text-muted mb-3"></i>
                    <h4 class="text-muted">No leads found</h4>
                    <p class="text-muted">Try adjusting your search criteria or add a new lead</p>
                    <button class="btn btn-primary" id="addLeadFromNoResults">
                        <i class="bi bi-plus-circle me-2"></i>Add New Lead
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Lead Modal -->
    <div class="modal fade" id="leadModal" tabindex="-1" aria-labelledby="leadModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalTitle">Add New Lead</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="leadForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Company Name *</label>
                                    <input type="text" class="form-control" id="companyName" placeholder="Enter company name" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Contact Name</label>
                                    <input type="text" class="form-control" id="contactName" placeholder="Contact person name">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Position</label>
                                    <input type="text" class="form-control" id="contactPosition" placeholder="Job title">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Email/Phone</label>
                                    <input type="text" class="form-control" id="email" placeholder="Email or phone number">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Division</label>
                                    <select class="form-select" id="division">
                                        <option value="tech">Gralix Tech</option>
                                        <option value="actuarial">Gralix Actuarial</option>
                                        <option value="capital">Gralix Capital</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Assign To *</label>
                                    <select class="form-select" id="assignedTo" required>
                                        <option value="">Select Personnel</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Priority Level</label>
                                    <select class="form-select" id="priority">
                                        <option value="high">High Priority</option>
                                        <option value="medium" selected>Medium Priority</option>
                                        <option value="low">Low Priority</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Deal Value (USD)</label>
                                    <input type="number" class="form-control" id="dealValue" placeholder="Potential deal value" min="0">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Next Follow-up Date</label>
                                    <input type="date" class="form-control" id="followupDate">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Comments & Notes</label>
                            <textarea class="form-control" id="comments" rows="3" placeholder="Add any relevant notes about this lead..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-primary" id="saveLeadBtn">
                        <i class="bi bi-check-circle me-1"></i>Save Lead
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Assignment Modal -->
    <div class="modal fade" id="bulkAssignModal" tabindex="-1" aria-labelledby="bulkAssignModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">Bulk Assignment</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Assignment Strategy</label>
                        <select class="form-select" id="assignmentStrategy">
                            <option value="manual">Manual Assignment</option>
                            <option value="round-robin">Round Robin</option>
                            <option value="workload">Based on Current Workload</option>
                            <option value="division">Based on Division Expertise</option>
                        </select>
                    </div>
                    <div class="mb-3" id="manualAssignmentDiv">
                        <label class="form-label">Assign All To</label>
                        <select class="form-select" id="bulkAssignPerson">
                            <option value="">Select Personnel</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Apply to</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="bulkScope" id="unassignedOnly" value="unassigned" checked>
                            <label class="form-check-label" for="unassignedOnly">
                                Unassigned leads only
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="bulkScope" id="allLeads" value="all">
                            <label class="form-check-label" for="allLeads">
                                All leads (reassign existing)
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-info" id="processBulkAssignmentBtn">
                        <i class="bi bi-people me-1"></i>Apply Assignment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add this script directly in the template -->
    <script>
        // Global variables
        let leads = [];
        let personnel = [];
        let filteredLeads = [];
        let editingLeadId = null;
        let currentView = 'all';
        let selectedLeads = [];
        let analytics = {};

        // CSRF token for Django
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            
            // Set up event listeners for buttons
            setupEventListeners();
            
            // Load initial data
            loadInitialData();
        });

        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Main action buttons
            document.getElementById('addLeadBtn').addEventListener('click', showAddForm);
            document.getElementById('bulkAssignBtn').addEventListener('click', showBulkAssignModal);
            
            // Modal save buttons
            document.getElementById('saveLeadBtn').addEventListener('click', saveLead);
            document.getElementById('processBulkAssignmentBtn').addEventListener('click', processBulkAssignment);
            
            // Filter buttons
            document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
            document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
            
            // Bulk action buttons
            document.getElementById('bulkReassignBtn').addEventListener('click', bulkReassign);
            document.getElementById('bulkUpdateStatusBtn').addEventListener('click', bulkUpdateStatus);
            document.getElementById('bulkDeleteBtn').addEventListener('click', bulkDelete);
            
            // Select all checkboxes
            document.getElementById('selectAll').addEventListener('change', toggleSelectAll);
            document.getElementById('selectAllHeader').addEventListener('change', toggleSelectAll);
            
            // Assignment strategy change
            document.getElementById('assignmentStrategy').addEventListener('change', function() {
                const strategy = this.value;
                const manualDiv = document.getElementById('manualAssignmentDiv');
                manualDiv.style.display = strategy === 'manual' ? 'block' : 'none';
            });
            
            // Filter inputs
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('divisionFilter').addEventListener('change', applyFilters);
            document.getElementById('priorityFilter').addEventListener('change', applyFilters);
            document.getElementById('personnelFilter').addEventListener('change', applyFilters);
        }

        // Basic functions
        function showAddForm() {
            console.log('showAddForm called');
            editingLeadId = null;
            document.getElementById('modalTitle').textContent = 'Add New Lead';
            clearForm();
            const modal = new bootstrap.Modal(document.getElementById('leadModal'));
            modal.show();
        }

        function showBulkAssignModal() {
            console.log('showBulkAssignModal called');
            const modal = new bootstrap.Modal(document.getElementById('bulkAssignModal'));
            modal.show();
        }

        function clearForm() {
            document.getElementById('companyName').value = '';
            document.getElementById('contactName').value = '';
            document.getElementById('contactPosition').value = '';
            document.getElementById('email').value = '';
            document.getElementById('followupDate').value = '';
            document.getElementById('division').value = 'tech';
            document.getElementById('assignedTo').value = '';
            document.getElementById('priority').value = 'medium';
            document.getElementById('dealValue').value = '';
            document.getElementById('comments').value = '';
        }

        // API calls
        async function apiCall(url, method = 'GET', data = null) {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
            };
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                showAlert('API call failed: ' + error.message, 'error');
                throw error;
            }
        }

        async function loadInitialData() {
            try {
                console.log('Loading initial data...');
                showLoading(true);
                
                // Load personnel first
                personnel = await apiCall('/api/personnel/');
                console.log('Personnel loaded:', personnel.length);
                populatePersonnelDropdowns();
                
                // Load leads
                leads = await apiCall('/api/leads/');
                console.log('Leads loaded:', leads.length);
                
                // Load analytics
                analytics = await apiCall('/api/analytics/');
                console.log('Analytics loaded');
                
                // Initial render
                filteredLeads = leads.slice();
                renderAll();
                
                showLoading(false);
            } catch (error) {
                console.error('Error loading initial data:', error);
                showAlert('Error loading data: ' + error.message, 'error');
                showLoading(false);
            }
        }

        function showLoading(show) {
            const indicator = document.getElementById('loadingIndicator');
            if (indicator) {
                indicator.style.display = show ? 'block' : 'none';
            }
        }

        function showAlert(message, type = 'success') {
            console.log('Alert:', type, message);
            
            // Create alert element
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function populatePersonnelDropdowns() {
            const dropdowns = ['assignedTo', 'bulkAssignPerson'];
            const personnelFilter = document.getElementById('personnelFilter');
            
            // Clear existing options (except first two)
            const existingOptions = personnelFilter.querySelectorAll('option:not(:first-child):not([value="unassigned"])');
            existingOptions.forEach(option => option.remove());
            
            // Populate filter dropdown
            personnel.forEach(function(person) {
                const option = document.createElement('option');
                option.value = person.id;
                option.textContent = person.name + ' (' + getDivisionLabel(person.division) + ')';
                personnelFilter.appendChild(option);
            });
            
            // Populate other dropdowns
            dropdowns.forEach(function(dropdownId) {
                const dropdown = document.getElementById(dropdownId);
                if (dropdown) {
                    dropdown.innerHTML = '<option value="">Select Personnel</option>';
                    personnel.forEach(function(person) {
                        const option = document.createElement('option');
                        option.value = person.id;
                        option.textContent = person.name + ' (' + getDivisionLabel(person.division) + ')';
                        dropdown.appendChild(option);
                    });
                }
            });
        }

        function renderAll() {
            console.log('Rendering all components...');
            renderQuickViewCards();
            renderAnalytics();
            renderLeadsTable();
            updateResultsCount();
        }

        function renderQuickViewCards() {
            // Simplified version for testing
            const html = `
                <div class="col-md-3 mb-3 col-lg-2">
                    <div class="card quick-view-card">
                        <div class="card-body text-center">
                            <i class="bi bi-people fs-1 text-primary mb-2"></i>
                            <h3 class="card-title text-primary">${leads.length}</h3>
                            <p class="card-text text-muted">All Leads</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3 col-lg-2">
                    <div class="card quick-view-card">
                        <div class="card-body text-center">
                            <i class="bi bi-fire fs-1 text-danger mb-2"></i>
                            <h3 class="card-title text-danger">${countByStatus('hot')}</h3>
                            <p class="card-text text-muted">Hot Leads</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('quickViewCards').innerHTML = html;
        }

        function renderAnalytics() {
            const totalPipeline = analytics.total_pipeline || 0;
            const avgDeal = analytics.avg_deal || 0;
            const conversionRate = analytics.conversion_rate || 0;

            // Revenue Overview
            document.getElementById('revenueOverview').innerHTML = `
                <div class="row g-3">
                    <div class="col-6">
                        <div class="card analytics-card success">
                            <div class="card-body text-center">
                                <h3 class="text-success">${totalPipeline.toLocaleString()}</h3>
                                <small class="text-muted">Total Pipeline Value</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card analytics-card primary">
                            <div class="card-body text-center">
                                <h3 class="text-primary">${Math.round(avgDeal).toLocaleString()}</h3>
                                <small class="text-muted">Average Deal Size</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="card analytics-card warning">
                            <div class="card-body text-center">
                                <h3 class="text-warning">${conversionRate.toFixed(1)}%</h3>
                                <small class="text-muted">Conversion Rate</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Division Performance
            const divisions = [
                {key: 'tech', label: 'Gralix Tech', color: 'primary'},
                {key: 'actuarial', label: 'Gralix Actuarial', color: 'success'}, 
                {key: 'capital', label: 'Gralix Capital', color: 'warning'}
            ];
            
            let divisionHtml = '<div class="row g-3">';
            divisions.forEach(div => {
                const divisionData = analytics.division_performance?.[div.key] || {count: 0, revenue: 0};
                divisionHtml += `
                    <div class="col-12">
                        <div class="card analytics-card ${div.color}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="text-${div.color}">${div.label}</h5>
                                        <small class="text-muted">${divisionData.count} leads</small>
                                    </div>
                                    <h4 class="text-${div.color} mb-0">${divisionData.revenue.toLocaleString()}</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            divisionHtml += '</div>';
            document.getElementById('divisionPerformance').innerHTML = divisionHtml;

            // Team Performance
            const topPerformers = analytics.top_performers || [];
            let teamHtml = '<div class="row g-2">';
            topPerformers.slice(0, 3).forEach(performer => {
                teamHtml += `
                    <div class="col-12">
                        <div class="card analytics-card info">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="personnel-avatar me-3">${performer.avatar}</div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-0">${performer.name}</h6>
                                        <small class="text-muted">${performer.leads_count} leads</small>
                                    </div>
                                    <h5 class="text-info mb-0">${performer.total_value.toLocaleString()}</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            teamHtml += '</div>';
            document.getElementById('teamPerformance').innerHTML = teamHtml;

            // Deal Stage Pipeline
            const statusCounts = analytics.status_counts || {};
            const stageStats = [
                { 
                    label: 'New Leads', 
                    count: statusCounts.new || 0, 
                    value: calculateStatusValue('new'), 
                    color: 'primary' 
                },
                { 
                    label: 'In Progress', 
                    count: (statusCounts.contacted || 0) + (statusCounts.qualified || 0), 
                    value: calculateStatusValue('contacted') + calculateStatusValue('qualified'), 
                    color: 'info' 
                },
                { 
                    label: 'Hot Prospects', 
                    count: (statusCounts.hot || 0) + (statusCounts.proposal || 0), 
                    value: calculateStatusValue('hot') + calculateStatusValue('proposal'), 
                    color: 'warning' 
                },
                { 
                    label: 'Closing', 
                    count: statusCounts.negotiation || 0, 
                    value: calculateStatusValue('negotiation'), 
                    color: 'success' 
                }
            ];
            
            let stageHtml = '';
            stageStats.forEach(stage => {
                stageHtml += `
                    <div class="col-md-3">
                        <div class="card analytics-card ${stage.color}">
                            <div class="card-body text-center">
                                <h4 class="text-${stage.color}">${stage.count}</h4>
                                <h6 class="text-muted">${stage.label}</h6>
                                <small class="text-muted">${stage.value.toLocaleString()}</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('dealStagePipeline').innerHTML = stageHtml;
        }

        function renderLeadsTable() {
            const tbody = document.getElementById('leadsTableBody');
            const noResultsDiv = document.getElementById('noResultsMessage');
            
            if (filteredLeads.length === 0) {
                tbody.innerHTML = '';
                noResultsDiv.style.display = 'block';
                return;
            }
            
            noResultsDiv.style.display = 'none';
            let html = '';

            filteredLeads.forEach(lead => {
                const hasRecentComm = lead.communications && lead.communications.length > 0;
                
                html += `
                    <tr>
                        <td>
                            <input type="checkbox" class="lead-checkbox" value="${lead.id}">
                        </td>
                        <td>
                            <div class="d-flex align-items-start">
                                <div class="flex-grow-1">
                                    <strong class="lead-company-link" style="cursor: pointer; color: #0d6efd;">${lead.company}</strong>
                                    ${lead.comments ? '<br><small class="text-muted">' + lead.comments + '</small>' : ''}
                                    ${hasRecentComm ? '<div class="mt-1"><span class="badge bg-info text-dark"><i class="bi bi-clock me-1"></i>' + lead.communications[0].date + '</span></div>' : ''}
                                </div>
                            </div>
                        </td>
                        <td>
                            <div>${lead.contact_name || '-'}</div>
                            ${lead.position ? '<small class="text-muted">' + lead.position + '</small>' : ''}
                            ${lead.email ? '<br><small><i class="bi bi-' + (lead.email.indexOf('@') !== -1 ? 'envelope' : 'telephone') + ' me-1"></i>' + lead.email + '</small>' : ''}
                        </td>
                        <td>
                            ${lead.assigned_to_name ? 
                                '<div class="d-flex align-items-center">' +
                                '<div class="personnel-avatar me-2">' + lead.assigned_to_avatar + '</div>' +
                                '<div>' +
                                '<div class="fw-semibold">' + lead.assigned_to_name + '</div>' +
                                '<small class="text-muted">' + getDivisionLabel(lead.assigned_to_division) + '</small>' +
                                '</div></div>' 
                                : 
                                '<span class="text-muted">Unassigned</span><br><button class="btn btn-sm btn-outline-primary mt-1" onclick="quickAssign(' + lead.id + ')">Assign</button>'
                            }
                        </td>
                        <td><span class="badge division-${lead.division}">${getDivisionLabel(lead.division)}</span></td>
                        <td>
                            ${getStatusBadge(lead.status)}
                            <div class="mt-1">
                                <div class="stage-progress">
                                    <div class="stage-progress-fill" style="width: ${lead.progress || 0}%"></div>
                                </div>
                                <small class="text-muted">${lead.progress || 0}% complete</small>
                            </div>
                        </td>
                        <td><span class="priority-${lead.priority}">${lead.priority.toUpperCase()}</span></td>
                        <td><strong>${(lead.deal_value || 0).toLocaleString()}</strong></td>
                        <td>
                            ${lead.follow_up_date ? 
                                '<span class="text-success"><i class="bi bi-calendar me-1"></i>' + lead.follow_up_date + '</span>' 
                                : 
                                '<span class="text-muted">Not scheduled</span>'
                            }
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-info" title="View Details">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-outline-primary" onclick="editLead(${lead.id})" title="Edit Lead">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-success" title="Log Communication">
                                    <i class="bi bi-chat-dots"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
            
            // Add event listeners to checkboxes
            document.querySelectorAll('.lead-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateSelectedLeads);
            });
        }

        // Save lead function
        async function saveLead() {
            const companyName = document.getElementById('companyName').value.trim();
            if (!companyName) {
                alert('Company name is required');
                document.getElementById('companyName').focus();
                return;
            }

            const assignedTo = document.getElementById('assignedTo').value;
            if (!assignedTo) {
                alert('Please assign this lead to a team member');
                document.getElementById('assignedTo').focus();
                return;
            }

            const formData = {
                company: companyName,
                contact_name: document.getElementById('contactName').value.trim(),
                position: document.getElementById('contactPosition').value.trim(),
                email: document.getElementById('email').value.trim(),
                follow_up_date: document.getElementById('followupDate').value || null,
                division: document.getElementById('division').value,
                priority: document.getElementById('priority').value,
                deal_value: parseFloat(document.getElementById('dealValue').value) || 0,
                comments: document.getElementById('comments').value.trim(),
                assigned_to: parseInt(assignedTo)
            };

            try {
                showLoading(true);
                
                if (editingLeadId) {
                    const response = await apiCall(`/api/leads/${editingLeadId}/update/`, 'PUT', formData);
                    const index = leads.findIndex(l => l.id === editingLeadId);
                    if (index !== -1) {
                        leads[index] = response;
                    }
                    showAlert('Lead updated successfully');
                } else {
                    const response = await apiCall('/api/leads/create/', 'POST', formData);
                    leads.push(response);
                    showAlert('Lead created successfully');
                }

                bootstrap.Modal.getInstance(document.getElementById('leadModal')).hide();
                
                // Reload data to get fresh analytics
                await loadInitialData();
                
                showLoading(false);
            } catch (error) {
                console.error('Error saving lead:', error);
                showAlert('Error saving lead: ' + error.message, 'danger');
                showLoading(false);
            }
        }

        // Bulk assignment function
        async function processBulkAssignment() {
            const strategy = document.getElementById('assignmentStrategy').value;
            const scope = document.querySelector('input[name="bulkScope"]:checked').value;
            const manualAssignee = document.getElementById('bulkAssignPerson').value;
            
            if (strategy === 'manual' && !manualAssignee) {
                alert('Please select a person to assign leads to');
                return;
            }
            
            try {
                showLoading(true);
                
                const data = {
                    strategy: strategy,
                    scope: scope,
                    manual_assignee_id: manualAssignee ? parseInt(manualAssignee) : null
                };
                
                const response = await apiCall('/api/bulk-assign/', 'POST', data);
                
                bootstrap.Modal.getInstance(document.getElementById('bulkAssignModal')).hide();
                
                // Reload all data
                await loadInitialData();
                
                showAlert(response.message);
                showLoading(false);
            } catch (error) {
                console.error('Error in bulk assignment:', error);
                showAlert('Error in bulk assignment: ' + error.message, 'danger');
                showLoading(false);
            }
        }

        // Utility functions
        function updateSelectedLeads() {
            const checkboxes = document.querySelectorAll('.lead-checkbox:checked');
            selectedLeads = Array.from(checkboxes).map(cb => parseInt(cb.value));
            updateSelectAllState();
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll').checked;
            const checkboxes = document.querySelectorAll('.lead-checkbox');
            
            checkboxes.forEach(cb => {
                cb.checked = selectAll;
            });
            
            updateSelectedLeads();
        }

        function updateSelectAllState() {
            const checkboxes = document.querySelectorAll('.lead-checkbox');
            const checkedBoxes = document.querySelectorAll('.lead-checkbox:checked');
            const selectAll = document.getElementById('selectAll');
            const selectAllHeader = document.getElementById('selectAllHeader');
            
            if (checkboxes.length === 0) {
                selectAll.indeterminate = false;
                selectAll.checked = false;
                selectAllHeader.indeterminate = false;
                selectAllHeader.checked = false;
            } else if (checkedBoxes.length === checkboxes.length) {
                selectAll.indeterminate = false;
                selectAll.checked = true;
                selectAllHeader.indeterminate = false;
                selectAllHeader.checked = true;
            } else if (checkedBoxes.length > 0) {
                selectAll.indeterminate = true;
                selectAllHeader.indeterminate = true;
            } else {
                selectAll.indeterminate = false;
                selectAll.checked = false;
                selectAllHeader.indeterminate = false;
                selectAllHeader.checked = false;
            }
        }

        function applyFilters() {
            console.log('Applying filters...');
            // Simple filter implementation for now
            filteredLeads = leads.slice();
            renderLeadsTable();
            updateResultsCount();
        }

        function clearFilters() {
            console.log('Clearing filters...');
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('divisionFilter').value = 'all';
            document.getElementById('priorityFilter').value = 'all';
            document.getElementById('personnelFilter').value = 'all';
            filteredLeads = leads.slice();
            renderAll();
        }

        function updateResultsCount() {
            document.getElementById('resultsCount').textContent = filteredLeads.length;
        }

        function countByStatus(status) {
            return leads.filter(lead => lead.status === status).length;
        }

        function calculateStatusValue(status) {
            return leads.filter(lead => lead.status === status)
                       .reduce((sum, lead) => sum + (parseFloat(lead.deal_value) || 0), 0);
        }

        function getStatusBadge(status) {
            const badges = {
                new: '<span class="badge bg-primary"><i class="bi bi-star me-1"></i>New</span>',
                contacted: '<span class="badge bg-info"><i class="bi bi-telephone me-1"></i>Contacted</span>',
                qualified: '<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Qualified</span>',
                proposal: '<span class="badge bg-warning text-dark"><i class="bi bi-file-text me-1"></i>Proposal</span>',
                negotiation: '<span class="badge bg-orange"><i class="bi bi-chat-square-dots me-1"></i>Negotiation</span>',
                hot: '<span class="badge bg-danger"><i class="bi bi-fire me-1"></i>Hot</span>',
                won: '<span class="badge bg-success"><i class="bi bi-trophy me-1"></i>Won</span>',
                lost: '<span class="badge bg-dark"><i class="bi bi-x-circle me-1"></i>Lost</span>',
                inactive: '<span class="badge bg-secondary"><i class="bi bi-pause-circle me-1"></i>Inactive</span>'
            };
            return badges[status] || badges.new;
        }

        function getDivisionLabel(division) {
            const labels = {
                tech: 'Gralix Tech',
                actuarial: 'Gralix Actuarial',
                capital: 'Gralix Capital'
            };
            return labels[division] || division;
        }

        // Placeholder functions for now
        function editLead(id) {
            console.log('Edit lead:', id);
            // Implementation to be added
        }

        function quickAssign(leadId) {
            console.log('Quick assign:', leadId);
            // Implementation to be added
        }

        function bulkReassign() {
            console.log('Bulk reassign');
            if (selectedLeads.length === 0) {
                alert('Please select leads to reassign');
                return;
            }
            // Implementation to be added
        }

        function bulkUpdateStatus() {
            console.log('Bulk update status');
            if (selectedLeads.length === 0) {
                alert('Please select leads to update');
                return;
            }
            // Implementation to be added
        }

        function bulkDelete() {
            console.log('Bulk delete');
            if (selectedLeads.length === 0) {
                alert('Please select leads to delete');
                return;
            }
            // Implementation to be added
        }
    </script>
{% endblock %}